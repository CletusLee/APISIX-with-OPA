# ============================================================================
# APISIX Standalone Configuration - Canary Deployment with OPA
# ============================================================================
# This configuration implements a canary deployment strategy where:
# - Normal users are routed to V1 (Stable)
# - Beta users are routed to V2 (Canary)
# - OPA (Open Policy Agent) makes the routing decision based on user identity
# ============================================================================

# ----------------------------------------------------------------------------
# UPSTREAMS: Define backend service targets
# ----------------------------------------------------------------------------
upstreams:
  # Backend V1 - Stable version (default)
  - id: 1
    name: backend-v1
    # Points to host machine port 8081 where backend-v1 container is exposed
    # Using host.docker.internal allows APISIX container to reach host-exposed ports
    nodes:
      "host.docker.internal:8081": 1
    type: roundrobin
    
  # Backend V2 - Canary version (for beta users)
  - id: 2
    name: backend-v2
    # Points to host machine port 8082 where backend-v2 container is exposed
    nodes:
      "host.docker.internal:8082": 1
    type: roundrobin

# ----------------------------------------------------------------------------
# ROUTES: Define request routing rules
# ----------------------------------------------------------------------------
routes:
  - id: 1
    # Match all requests
    uri: /*
    
    # Default upstream: V1 (Stable)
    # This is used when no routing override is applied
    upstream_id: 1
    
    # Plugin chain for OPA-based canary routing
    plugins:
      # -----------------------------------------------------------------------
      # Plugin 1: serverless-pre-function (Lua script)
      # -----------------------------------------------------------------------
      # Purpose: Call OPA policy engine and inject routing headers
      # Execution Phase: rewrite (runs before upstream selection)
      # -----------------------------------------------------------------------
      serverless-pre-function:
        phase: rewrite
        functions:
          - |
            return function(conf, ctx)
              local core = require("apisix.core")
              local http = require("resty.http")
              
              -- Extract user ID
              local user_id = core.request.header(ctx, "x-user-id") or "NONE"
              
              -- Initialize HTTP client
              local httpc = http.new()
              httpc:set_timeout(3000)
              
              -- Call OPA
              local opa_res, err = httpc:request_uri("http://opa:8181/v1/data/backend/authz", {
                method = "POST",
                body = core.json.encode({
                  input = {
                    request = {
                      headers = {
                        ["x-user-id"] = user_id
                      }
                    }
                  }
                }),
                headers = {
                  ["Content-Type"] = "application/json"
                }
              })
              
              if not opa_res then
                core.log.error("OPA call failed: ", tostring(err))
                return 503
              end
              
              if opa_res.status ~= 200 then
                core.log.error("OPA returned non-200 status: ", opa_res.status)
                return 503
              end
              
              -- Parse response
              local opa_data, decode_err = core.json.decode(opa_res.body)
              if not opa_data then
                core.log.error("Failed to decode OPA response: ", tostring(decode_err))
                return 503
              end
              
              -- Check structure
              if not opa_data.result then
                core.log.error("OPA response missing 'result' field")
                return 503
              end
              
              -- Check authorization
              if opa_data.result.allow == false then
                core.log.warn("OPA denied request")
                return 403
              end
              
              -- Inject routing header if present and set upstream
              local target = nil
              if opa_data.result.headers then
                  target = opa_data.result.headers["X-Target-Upstream"] or opa_data.result.headers["x-target-upstream"]
              end
              
              if target then
                core.request.set_header(ctx, "X-Target-Upstream", target)
                
                -- Direct upstream selection (v2 -> ID 2)
                if target == "v2" then
                    ctx.upstream_id = 2
                end
              end
            end

#END
