upstreams:
  - id: 1
    name: backend-v1
    # Use service name from docker-compose
    nodes:
      "host.docker.internal:8081": 1
    type: roundrobin
  - id: 2
    name: backend-v2
    # Use service name from docker-compose
    nodes:
      "host.docker.internal:8082": 1
    type: roundrobin

routes:
  - id: 1
    uri: /*
    upstream_id: 1 # Default to V1
    plugins:
      serverless-pre-function:
        phase: rewrite
        functions:
          - |
            return function(conf, ctx)
              local core = require("apisix.core")
              local http = require("resty.http")
              
              -- Get x-user-id header
              local user_id = core.request.header(ctx, "x-user-id")
              
              -- Call OPA
              local httpc = http.new()
              httpc:set_timeout(3000)
              
              local opa_res, err = httpc:request_uri("http://172.20.0.3:8181/v1/data/apisix/route", {
                method = "POST",
                body = core.json.encode({
                  input = {
                    type = "http",
                    request = {
                      headers = {
                        ["x-user-id"] = user_id
                      }
                    }
                  }
                }),
                headers = {
                  ["Content-Type"] = "application/json"
                }
              })
              
              if not opa_res then
                core.log.error("failed to call OPA: ", err)
                return 503
              end
              
              if opa_res.status ~= 200 then
                core.log.error("OPA returned non-200: ", opa_res.status)
                return 503
              end
              
              local opa_data = core.json.decode(opa_res.body)
              
              if not opa_data or not opa_data.result then
                core.log.error("invalid OPA response")
                return 503
              end
              
              if not opa_data.result.allow then
                return 403
              end
              
              -- Set header for traffic-split if OPA returned headers
              if opa_data.result.headers and opa_data.result.headers["X-Target-Upstream"] then
                core.request.set_header(ctx, "X-Target-Upstream", opa_data.result.headers["X-Target-Upstream"])
              end
            end
      traffic-split:
        rules:
          - match:
              - vars: 
                  - ["http_x_target_upstream", "==", "v2"]
            weighted_upstreams:
              - upstream_id: 2
                weight: 1
#END
